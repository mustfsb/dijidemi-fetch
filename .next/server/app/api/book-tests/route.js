"use strict";(()=>{var e={};e.id=343,e.ids=[343],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6681:e=>{e.exports=require("playwright")},586:e=>{e.exports=require("@sparticuz/chromium")},4205:e=>{e.exports=require("playwright-core")},1017:e=>{e.exports=require("path")},5565:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>m,originalPathname:()=>k,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>h,serverHooks:()=>p,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>w});var i={};s.r(i),s.d(i,{POST:()=>l});var a=s(5419),o=s(9108),r=s(9678),n=s(8070),c=s(7589);async function l(e){try{let{id:t}=await e.json();if(!t)return n.Z.json({error:"Book ID is required"},{status:400});let s=await c.Z.getHeaders(),i=`https://www.dijidemi.com/Ogrenci/KitapTestlerTable?Id=${t}&___layout`,a=await fetch(i,{method:"POST",headers:s,body:""});if(!a.ok)return n.Z.json({error:`Upstream error: ${a.status}`},{status:a.status});let o=await a.text(),r=[];for(let e of[...o.matchAll(/<h3>(.*?)<\/h3>[\s\S]*?data-rowid="(\d+)"/g)]){let t=e[1].trim(),s=e[2];t=t.replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(parseInt(t,10))),r.push({name:t,id:s})}return n.Z.json({success:!0,tests:r})}catch(e){return n.Z.json({error:"Internal Server Error"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/book-tests/route",pathname:"/api/book-tests",filename:"route",bundlePath:"app/api/book-tests/route"},resolvedPagePath:"/Users/mustafa/Documents/GitHub/dijidemi-fetch/app/api/book-tests/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:d,serverHooks:p,headerHooks:m,staticGenerationBailout:w}=h,k="/api/book-tests/route";function f(){return(0,r.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:d})}},7589:(e,t,s)=>{s.d(t,{Z:()=>u});class i{constructor(){}static getInstance(){return i.instance||(i.instance=new i),i.instance}async getFreshCookies(){let e;if(process.env.AWS_LAMBDA_FUNCTION_VERSION||process.env.NETLIFY||process.env.AWS_LAMBDA_FUNCTION_NAME){let t=await Promise.resolve().then(s.t.bind(s,586,23)),{chromium:i}=await Promise.resolve().then(s.t.bind(s,4205,23)),a=t.default||t,o=await a.executablePath();e=await i.launch({args:a.args,executablePath:o,headless:a.headless})}else{let{chromium:t}=await Promise.resolve().then(s.t.bind(s,6681,23));e=await t.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled"]})}try{let t=await e.newContext({userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",viewport:{width:1280,height:720},locale:"tr-TR",timezoneId:"Europe/Istanbul"}),s=await t.newPage();await s.goto("https://www.dijidemi.com/login",{waitUntil:"domcontentloaded",timeout:6e4});try{await s.waitForSelector("#txtUserName",{state:"visible",timeout:3e4})}catch(e){await s.waitForTimeout(5e3)}try{await s.isVisible("#txtUserName")&&(await s.fill("#txtUserName","14308-1651"),await s.fill("#txtPassword","175F7"),await s.click("#btnLogin"),await s.waitForLoadState("networkidle",{timeout:3e4}))}catch(e){}let i=await t.cookies(),a={cf_clearance:"","ASP.NET_SessionId":"",usrtkn:""};return i.forEach(e=>{(e.name in a||["cf_clearance","ASP.NET_SessionId","usrtkn"].includes(e.name))&&(a[e.name]=e.value)}),Object.entries(a).filter(([e,t])=>!t&&["cf_clearance","ASP.NET_SessionId"].includes(e)).map(([e])=>e).length,a}catch(e){throw e}finally{e&&await e.close()}}}let a=i.getInstance();var o=s(7028);let r=require("fs");var n=s.n(r),c=s(1017),l=s.n(c);class h{constructor(){this.isRefreshing=!1,this.refreshPromise=null,this.lastDbCheck=0,this.DB_CHECK_INTERVAL=3e5,this.cookies={cf_clearance:"","ASP.NET_SessionId":"",usrtkn:""},this.baseHeaders={Host:"www.dijidemi.com",Accept:"application/json, text/plain, */*","User-Agent":"DijidemiMobile/41 CFNetwork/3860.300.31 Darwin/25.2.0","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive"}}getCookieString(){return Object.entries(this.cookies).filter(([e,t])=>t).map(([e,t])=>`${e}=${t}`).join("; ")}async loadFromSupabase(){try{let{data:e,error:t}=await o.O.from("auth_cookies").select("*").order("updated_at",{ascending:!1}).limit(1).single();if(t)return t.code,!1;if(e&&e.cookie_json){let t="string"==typeof e.cookie_json?JSON.parse(e.cookie_json):e.cookie_json;return this.cookies={...this.cookies,...t},!0}}catch(e){}return!1}async saveToSupabase(e){try{let{error:t}=await o.O.from("auth_cookies").upsert({id:1,cookie_json:e,updated_at:new Date().toISOString()});t&&t.code;try{let t=!!process.env.AWS_LAMBDA_FUNCTION_VERSION||!!process.env.NETLIFY||!!process.env.AWS_LAMBDA_FUNCTION_NAME,s=t?"/tmp":l().join(process.cwd(),"lib/cookie");t||n().existsSync(s)||n().mkdirSync(s,{recursive:!0});let i=l().join(s,"cookies.json");n().writeFileSync(i,JSON.stringify(e,null,2))}catch(e){}}catch(e){}}async ensureValidCookies(e=!1){let t=this.cookies.cf_clearance&&this.cookies["ASP.NET_SessionId"],s=Date.now()-this.lastDbCheck;if((!t||s>this.DB_CHECK_INTERVAL)&&(await this.loadFromSupabase(),this.lastDbCheck=Date.now()),!this.cookies.cf_clearance||!this.cookies["ASP.NET_SessionId"]||e){if(this.isRefreshing){this.refreshPromise&&await this.refreshPromise;return}this.isRefreshing=!0,this.refreshPromise=(async()=>{try{let e=await a.getFreshCookies();e["ASP.NET_SessionId"]&&!e.usrtkn&&(e.usrtkn=`tkn=${e["ASP.NET_SessionId"]}`),this.cookies={...this.cookies,...e},await this.saveToSupabase(this.cookies)}catch(e){}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),await this.refreshPromise}}async getHeaders(){return await this.ensureValidCookies(!1),{...this.baseHeaders,Cookie:this.getCookieString()}}async refreshCookies(){await this.ensureValidCookies(!0)}}let u=new h},7028:(e,t,s)=>{s.d(t,{O:()=>o});var i=s(2318);let a=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZnVncGZod2JnY3Vua2ZrcmhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTIxNTUsImV4cCI6MjA4MTM4ODE1NX0.M910703VczSYfcaucltLCNZKCb1-iHoyZr-5VmpkG1o",o=(0,i.eI)("https://mofugpfhwbgcunkfkrhc.supabase.co",a||"placeholder",{auth:{persistSession:!1,autoRefreshToken:!1}})}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),i=t.X(0,[638,206,318],()=>s(5565));module.exports=i})();